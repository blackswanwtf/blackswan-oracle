# BlackSwan Oracle Service and Contracts

[![Node.js](https://img.shields.io/badge/Node.js-18.0.0+-green.svg)](https://nodejs.org/)
[![License](https://img.shields.io/badge/License-MIT-blue.svg)](LICENSE)
[![Author](https://img.shields.io/badge/Author-Muhammad%20Bilal%20Motiwala-orange.svg)](https://github.com/bilalmotiwala)

A production-ready blockchain oracle service that takes the latest outputs of the Black Swan Analysis agents and the Market Peak Analysis agents and pushes the Black Swan Analysis Scores and Market Peak Analysis scores on-chain using a secure, upgradeable Oracle smart contract deployed on Base Mainnet.

**Author:** Muhammad Bilal Motiwala  
**Project:** Black Swan  
**Version:** 1.0.0

## ğŸ¯ Overview

The Black Swan Oracle Service is the core bridge between getting the analytical score generated by Black Swan onto the blockchain for use within other smart contracts and on-chain services. It continuously monitors the outputs of the Black Swan Analysis and Market Peak Analysis agents (facilitated with a small API layer for ease) and efficiently updates the on-chain oracle only when values change.

### Key Features

- **ğŸ”— Base Blockchain Integration**: Optimized for Base network (Chain ID: 8453)
- **ğŸ“Š Dual Score Monitoring**: Tracks both Black Swan and Market Peak Analysis Scores
- **âš¡ Smart Update Logic**: Only updates on-chain when scores actually change
- **ğŸ”„ Efficient Transaction Types**: Uses single-score or dual-score updates as needed
- **ğŸ›¡ï¸ UUPS Upgradeable Contract**: Future-proof smart contract architecture
- **ğŸ” Multi-Signature Support**: Owner and dev wallet access control
- **â° Configurable Polling**: Customizable monitoring intervals
- **ğŸš¨ Comprehensive Logging**: Real-time monitoring with emoji-rich logs
- **ğŸ’° Gas Optimization**: Intelligent gas pricing for Base network
- **ğŸ”„ Automatic Recovery**: Robust error handling with graceful degradation

## ğŸ—ï¸ Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Agent Analysis    â”‚    â”‚     Oracle      â”‚    â”‚   Base          â”‚
â”‚   (via API layer)   â”‚â—„â”€â”€â–ºâ”‚     Service     â”‚â”€â”€â”€â–¶â”‚   Blockchain    â”‚
â”‚                     â”‚    â”‚                 â”‚    â”‚                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚                        â”‚
                                â–¼                        â–¼
                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                           â”‚   Real-time     â”‚    â”‚   Smart         â”‚
                           â”‚   Monitoring    â”‚    â”‚   Contract      â”‚
                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“‹ Project Structure

```
blackswan-oracle/
â”œâ”€â”€ contracts/
â”‚   â””â”€â”€ BlackSwanOracle.sol    # UUPS upgradeable oracle contract
â”œâ”€â”€ abi/
â”‚   â””â”€â”€ BlackSwanOracle.json   # Contract ABI for service interaction
â”œâ”€â”€ src/
â”‚   â””â”€â”€ index.js               # Main oracle service implementation
â”œâ”€â”€ package.json               # Dependencies and scripts
â”œâ”€â”€ .gitignore                # Git ignore patterns
â””â”€â”€ README.md                 # This documentation
```

## ğŸš€ Quick Start

### Prerequisites

- **Node.js** >= 18.0.0
- **Base RPC Access** (Alchemy, Infura, or public RPC)
- **Deployed Contract** on Base network
- **Dev Wallet** with Base ETH for transactions
- **Black Swan Platform API** access (simple API layer generated over the Market Peak and Blackswan Analysis outputs)

### Installation

1. **Clone and Install**

   ```bash
   git clone <repository-url>
   cd blackswan-oracle
   npm install
   ```

2. **Environment Configuration**

   Create a `.env` file with the following configuration:

   ```env
   # Base Blockchain Configuration
   RPC_URL=https://base-mainnet.g.alchemy.com/v2/your-api-key
   DEV_WALLET_PRIVATE_KEY=your_64_character_private_key_without_0x_prefix

   # Smart Contract Configuration
   ORACLE_CONTRACT_ADDRESS=0x1234567890123456789012345678901234567890

   # API Configuration
   API_ENDPOINT=http://localhost:3001/api/oracle/stats

   # Polling Configuration
   POLL_INTERVAL=60000          # 1 minute (minimum recommended)

   # Gas Configuration (Base Optimized)
   GAS_LIMIT=150000             # Higher for Base network
   MAX_FEE_PER_GAS_GWEI=2       # Base-appropriate gas fees
   MAX_PRIORITY_FEE_PER_GAS_GWEI=0.05

   # Alternative Base RPC URLs (for redundancy)
   # RPC_URL=https://base-mainnet.infura.io/v3/your-key
   # RPC_URL=https://mainnet.base.org
   # RPC_URL=https://base.llamarpc.com
   ```

3. **Start the Oracle Service**

   ```bash
   # Production mode
   npm start

   # Development mode (with auto-restart)
   npm run dev
   ```

## ğŸ”§ Configuration

### Environment Variables

| Variable                        | Required | Default | Description                                                                    |
| ------------------------------- | -------- | ------- | ------------------------------------------------------------------------------ |
| `RPC_URL`                       | **Yes**  | -       | Base network RPC endpoint                                                      |
| `DEV_WALLET_PRIVATE_KEY`        | **Yes**  | -       | Private key (64 hex chars, no 0x prefix)                                       |
| `ORACLE_CONTRACT_ADDRESS`       | **Yes**  | -       | Deployed oracle contract address                                               |
| `API_ENDPOINT`                  | **Yes**  | -       | API endpoint generated over market peak and black swan analysis agent outcomes |
| `POLL_INTERVAL`                 | No       | 60000   | Polling interval in milliseconds                                               |
| `GAS_LIMIT`                     | No       | 150000  | Gas limit for transactions                                                     |
| `MAX_FEE_PER_GAS_GWEI`          | No       | -       | Maximum fee per gas unit (Base: ~2 gwei)                                       |
| `MAX_PRIORITY_FEE_PER_GAS_GWEI` | No       | -       | Priority fee per gas unit (Base: ~0.05 gwei)                                   |
| `GAS_PRICE_GWEI`                | No       | -       | Legacy gas price (if EIP-1559 not available)                                   |

### Base Network Configuration

The service is optimized for Base (Chain ID: 8453). Key considerations:

- **Gas Fees**: Base has low fees (~0.001-0.01 ETH per transaction)
- **Block Time**: ~2 seconds for fast confirmations
- **RPC Endpoints**: Use Alchemy, Infura, or public Base RPC

### Smart Contract Features

The oracle uses a UUPS upgradeable contract with:

- **Owner Controls**: Contract upgrades, dev wallet management, pause/unpause
- **Dev Wallet Access**: Score updates, read operations
- **Pausable**: Emergency stop functionality
- **Events**: Comprehensive event logging for all operations

## ğŸ“Š Score Update Logic

### Intelligent Update Strategy

The service implements smart update logic to minimize gas costs:

1. **Dual Score Monitoring**: Fetches both BlackSwan and Market Peak scores
2. **Change Detection**: Only triggers updates when scores actually change
3. **Efficient Transactions**:
   - **Single Update**: When only one score changes
   - **Batch Update**: When both scores change simultaneously
   - **No Update**: When neither score changes

### Update Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Poll API      â”‚
â”‚   Every Minute  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Compare       â”‚â—„â”€â”€â”€ Cached Values
â”‚   with Cache    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
   â”Œâ”€â”€â”€â”€ Changed? â”€â”€â”€â”€â”
   â”‚                  â”‚
   Yes                No
   â”‚                  â”‚
   â–¼                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Update        â”‚ â”‚   Continue      â”‚
â”‚   Contract      â”‚ â”‚   Monitoring    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Gas Optimization

- **Conditional Updates**: Only when data changes
- **Batch Operations**: Combined updates when possible
- **Base-Optimized**: Low gas settings for Base network
- **Smart Retry**: Automatic retry with adjusted gas on failure

## ğŸ” API Integration

### Black Swan Platform API

The service connects to a API layer generated off the analysis outcomes of the Black Swan analysis agent and the Market Peak Analysis Agent

**Endpoint**: `/api/oracle/stats`

**Expected Response**:

```json
{
  "blackswanScore": 75,
  "marketPeakScore": 60,
  "timestamp": 1703123456789,
  "status": "ready"
}
```

**Validation**:

- Both scores must be numbers â‰¥ 0
- Scores are converted to integers for blockchain storage
- API timeouts after 30 seconds
- Automatic retry on transient failures

## ğŸ“ˆ Monitoring & Logging

### Real-time Logs

The service provides comprehensive logging with emojis for easy monitoring:

```
2024-01-15 10:30:00 ğŸ“Š [INFO] ğŸ” Checking for score updates...
2024-01-15 10:30:01 ğŸ“Š [INFO] ğŸ“ˆ Fetched scores from API - BlackSwan: 75, MarketPeak: 60
2024-01-15 10:30:01 ğŸ“Š [INFO] ğŸ“ˆ BlackSwan score changed: 70 â†’ 75
2024-01-15 10:30:02 ğŸ“Š [INFO] ğŸš€ Updating oracle contract - BlackSwan: 75, MarketPeak: 60 (blackswan)
2024-01-15 10:30:03 ğŸ“Š [INFO] â³ BlackSwan score update transaction sent: 0xabc123...
2024-01-15 10:30:05 ğŸ“Š [INFO] âœ… Scores updated successfully! Block: 12345678, Gas used: 45000
2024-01-15 10:30:05 ğŸ“Š [INFO] ğŸ’¾ Cached scores updated
```

### Log Categories

| Emoji | Level | Category              | Description                    |
| ----- | ----- | --------------------- | ------------------------------ |
| ğŸ“Š    | INFO  | General Operations    | Normal service operations      |
| ğŸ”    | INFO  | Data Fetching         | API polling and data retrieval |
| ğŸ“ˆ    | INFO  | Score Changes         | Score updates and comparisons  |
| ğŸš€    | INFO  | Blockchain Operations | Contract interactions          |
| â³    | INFO  | Transaction Progress  | Transaction submission         |
| âœ…    | INFO  | Success Operations    | Successful completions         |
| ğŸ’¾    | INFO  | Cache Operations      | Data caching and storage       |
| âš ï¸    | WARN  | Warnings              | Non-critical issues            |
| âŒ    | ERROR | Errors                | Critical failures              |

### Health Monitoring

Monitor these key indicators:

- **API Response Time**: Should be < 5 seconds
- **Transaction Success Rate**: Should be > 95%
- **Gas Usage**: Monitor for unusual spikes
- **Score Update Frequency**: Track how often scores change
- **Wallet Balance**: Alert when ETH balance is low

## ğŸ› ï¸ Development

### Local Development

```bash
# Install dependencies
npm install

# Run with auto-restart
npm run dev

# Check code style
npm run lint

# Format code
npm run format
```

### Testing

```bash
# Test API connectivity
curl http://localhost:3001/api/oracle/stats

# Check contract interaction (requires deployed contract)
npm start

# Monitor logs
tail -f logs/oracle.log
```

### Smart Contract Development

The oracle contract supports:

```solidity
// Single score updates
updateBlackSwanScore(uint256 newScore)
updateMarketPeakScore(uint256 newScore)

// Batch update (more gas efficient)
updateBothScores(uint256 newBlackSwanScore, uint256 newMarketPeakScore)

// Read operations
getBothScores() returns (uint256, uint256)
blackSwanScore() returns (uint256)
marketPeakScore() returns (uint256)
```

## ğŸš€ Deployment

### Production Deployment

1. **Server Setup**

   ```bash
   # Clone to production server
   git clone <repository-url>
   cd blackswan-oracle
   npm ci --production
   ```

2. **Environment Configuration**

   ```env
   # Production environment
   NODE_ENV=production
   RPC_URL=https://base-mainnet.g.alchemy.com/v2/production-key
   API_ENDPOINT=http://localhost:3001/api/oracle/stats
   POLL_INTERVAL=60000
   ```

3. **Process Management**

   ```bash
   # Using PM2
   npm install -g pm2
   pm2 start src/index.js --name "blackswan-oracle"
   pm2 startup
   pm2 save

   # Using systemd
   sudo systemctl enable blackswan-oracle
   sudo systemctl start blackswan-oracle
   ```

### Docker Deployment

```dockerfile
FROM node:18-alpine

WORKDIR /app
COPY package*.json ./
RUN npm ci --production

COPY . .

USER node
CMD ["npm", "start"]
```

```bash
# Build and run
docker build -t blackswan-oracle .
docker run -d --env-file .env --name oracle blackswan-oracle
```

### Base Network Deployment

For Base mainnet deployment:

1. **Get Base ETH**: Bridge from Ethereum mainnet
2. **Deploy Contract**: Use Remix, Hardhat, or Foundry
3. **Add Dev Wallet**: Call `addDevWallet()` with service wallet
4. **Configure Service**: Update `.env` with contract address

### Monitoring Setup

```bash
# Health check endpoint (add to your monitoring)
curl http://localhost:3000/health

# Log monitoring
tail -f /var/log/blackswan-oracle/app.log

# Performance monitoring
htop | grep "node.*oracle"
```

## ğŸ”’ Security

### Best Practices

1. **Private Key Security**

   - Use environment variables only
   - Never commit private keys to version control
   - Consider using hardware wallets or key management services
   - Rotate keys regularly

2. **Access Control**

   - Deploy contract with secure initial owner
   - Use multi-signature wallets for production
   - Limit dev wallet permissions to necessary functions
   - Regular access audits

3. **Network Security**

   - Use HTTPS for all API endpoints
   - Implement API rate limiting
   - Monitor for unusual transaction patterns
   - Set up alerts for failed transactions

4. **Smart Contract Security**
   - Contract is pausable for emergencies
   - Upgradeable pattern allows security fixes
   - Events provide transaction transparency
   - Access controls prevent unauthorized updates

### Security Checklist

- [ ] Private keys stored securely (not in code)
- [ ] Environment variables properly configured
- [ ] Contract deployed with correct owner
- [ ] Dev wallet added to contract allowlist
- [ ] API endpoints use HTTPS
- [ ] Monitoring and alerting configured
- [ ] Backup RPC endpoints configured
- [ ] Regular security updates scheduled

## ğŸ› Troubleshooting

### Common Issues

#### 1. "Missing required environment variable"

```bash
# Check your .env file
cat .env

# Verify all required variables are set
grep -E "(RPC_URL|DEV_WALLET_PRIVATE_KEY|ORACLE_CONTRACT_ADDRESS|API_ENDPOINT)" .env
```

#### 2. "Invalid contract address format"

```bash
# Ensure address is 42 characters with 0x prefix
echo $ORACLE_CONTRACT_ADDRESS | wc -c  # Should be 43 (including newline)
```

#### 3. "Connected to Chain ID X, but Base mainnet is 8453"

```bash
# Verify RPC URL points to Base mainnet
curl -X POST -H "Content-Type: application/json" \
  --data '{"jsonrpc":"2.0","method":"eth_chainId","params":[],"id":1}' \
  $RPC_URL
```

#### 4. "Insufficient funds in dev wallet"

```bash
# Check wallet balance on Base
# Use Base explorer: https://basescan.org/address/YOUR_WALLET_ADDRESS
```

#### 5. "API request timed out"

```bash
# Test API endpoint manually
curl -v http://localhost:3001/api/oracle/stats
```

#### 6. "Contract error: caller is not owner or dev wallet"

```bash
# Verify wallet is added as dev wallet in contract
# Check contract on BaseScan for dev wallet list
```

### Debug Mode

Enable detailed logging:

```env
LOG_LEVEL=debug
```

Check specific components:

```bash
# Test API connectivity
curl -v $API_ENDPOINT

# Test blockchain connection
node -e "
const { ethers } = require('ethers');
const provider = new ethers.JsonRpcProvider(process.env.RPC_URL);
provider.getNetwork().then(console.log);
"

# Verify contract ABI
node -e "
const abi = require('./abi/BlackSwanOracle.json');
console.log('Contract ABI loaded:', abi.length, 'functions');
"
```

### Performance Monitoring

Track key metrics:

```bash
# Service uptime
ps aux | grep "node.*index.js"

# Memory usage
top -p $(pgrep -f "node.*index.js")

# Blockchain connectivity
curl -X POST -H "Content-Type: application/json" \
  --data '{"jsonrpc":"2.0","method":"eth_blockNumber","params":[],"id":1}' \
  $RPC_URL
```

## ğŸ“š API Reference

### Service Methods

#### `fetchScoresFromAPI()`

Fetches both BlackSwan and Market Peak scores from the Black Swan Platform API layer.

**Returns**: `Promise<{blackswanScore: number, marketPeakScore: number}>`

#### `updateOracleScores(blackswanScore, marketPeakScore, updateType)`

Updates the oracle contract with new scores.

**Parameters**:

- `blackswanScore`: New BlackSwan score (integer)
- `marketPeakScore`: New Market Peak score (integer)
- `updateType`: "both" | "blackswan" | "marketpeak"

**Returns**: `Promise<boolean>` - Success status

#### `checkAndUpdateScores()`

Main monitoring loop that checks for changes and updates accordingly.

### Smart Contract Interface

```solidity
interface IBlackSwanOracle {
    function updateBlackSwanScore(uint256 newScore) external;
    function updateMarketPeakScore(uint256 newScore) external;
    function updateBothScores(uint256 newBlackSwanScore, uint256 newMarketPeakScore) external;
    function getBothScores() external view returns (uint256, uint256);
    function blackSwanScore() external view returns (uint256);
    function marketPeakScore() external view returns (uint256);
}
```

## ğŸ¤ Contributing

### Development Workflow

1. Fork the repository
2. Create a feature branch
3. Make your changes
4. Add tests if applicable
5. Update documentation
6. Submit a pull request

### Code Standards

- **ESLint**: Follow project linting rules
- **Comments**: Add JSDoc for new functions
- **Error Handling**: Always handle errors gracefully
- **Logging**: Use appropriate log levels with emojis
- **Security**: Never expose private keys or sensitive data

### Testing Guidelines

```bash
# Unit tests
npm test

# Integration tests
npm run test:integration

# Linting
npm run lint

# Security audit
npm audit
```

## ğŸ“„ License

This project is licensed under the MIT License - see the [LICENSE](LICENSE) file for details.

## ğŸ‘¨â€ğŸ’» Author

**Muhammad Bilal Motiwala**

- GitHub: [@bilalmotiwala](https://github.com/bilalmotiwala)
- Email: [bilal@oaiaolabs.com](mailto:bilal@oaiaolabs.com)

## ğŸ†˜ Support

### Getting Help

1. **Documentation**: Review this README and code comments
2. **Logs**: Check service logs for detailed error information
3. **API Testing**: Test components individually using provided commands
4. **GitHub Issues**: Create an issue for bugs or feature requests

### Community Resources

- **Base Documentation**: [docs.base.org](https://docs.base.org)
- **Ethers.js Docs**: [docs.ethers.org](https://docs.ethers.org)
- **Black Swan**: [blackswan.wtf](https://blackswan.wtf)

---

**âš ï¸ Important Notes:**

- **Security**: Keep private keys secure and never commit them to version control
- **Gas Fees**: Monitor Base network gas prices and adjust accordingly
- **Monitoring**: Set up proper monitoring and alerting for production use
- **Updates**: Keep dependencies updated for security patches
- **Testing**: Always test on testnet before mainnet deployment

**ğŸš€ Ready to deploy your oracle!**
