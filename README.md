# BlackSwan Oracle Service and Contracts

[![Node.js](https://img.shields.io/badge/Node.js-18.0.0+-green.svg)](https://nodejs.org/)
[![License](https://img.shields.io/badge/License-MIT-blue.svg)](LICENSE)
[![Author](https://img.shields.io/badge/Author-Muhammad%20Bilal%20Motiwala-orange.svg)](https://github.com/bilalmotiwala)

A production-ready blockchain oracle service that takes the latest outputs of the Black Swan Analysis agents and the Market Peak Analysis agents, uploads comprehensive analysis data to IPFS for cost-effective storage, and pushes both scores and IPFS hashes on-chain using a secure, upgradeable Oracle smart contract deployed on Base Mainnet.

**Author:** Muhammad Bilal Motiwala  
**Project:** Black Swan  
**Version:** 1.1.0

## üéØ Overview

The Black Swan Oracle Service is the core bridge between getting the analytical data generated by Black Swan onto the blockchain for use within other smart contracts and on-chain services. It continuously monitors the outputs of the Black Swan Analysis and Market Peak Analysis agents, creates comprehensive JSON analysis files, uploads them to IPFS via Pinata for cost-effective storage, and efficiently updates the on-chain oracle with both scores and IPFS hashes when values change.

This hybrid approach significantly reduces on-chain storage costs while maintaining full data availability through decentralized storage.

### Key Features

- **üîó Base Blockchain Integration**: Optimized for Base network (Chain ID: 8453)
- **üìä Dual Score Monitoring**: Tracks both Black Swan and Market Peak Analysis Scores
- **üìå IPFS Integration**: Uploads comprehensive analysis data to IPFS via Pinata
- **üíæ Cost-Effective Storage**: Stores full analysis off-chain while keeping scores and hashes on-chain
- **üåê Decentralized Data Access**: Analysis data accessible through IPFS gateways
- **‚ö° Smart Update Logic**: Only updates on-chain when scores actually change
- **üîÑ Efficient Transaction Types**: Combined score and IPFS hash updates
- **üõ°Ô∏è UUPS Upgradeable Contract**: Future-proof smart contract architecture
- **üîê Multi-Signature Support**: Owner and dev wallet access control
- **‚è∞ Configurable Polling**: Customizable monitoring intervals
- **üö® Comprehensive Logging**: Real-time monitoring with emoji-rich logs
- **üí∞ Gas Optimization**: Intelligent gas pricing for Base network
- **üîÑ Automatic Recovery**: Robust error handling with graceful degradation

## üèóÔ∏è Architecture

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Agent Analysis    ‚îÇ    ‚îÇ   Oracle Service    ‚îÇ    ‚îÇ   Base          ‚îÇ
‚îÇ   (via API layer)   ‚îÇ‚óÑ‚îÄ‚îÄ‚ñ∫‚îÇ  - Fetch Analysis   ‚îÇ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ   Blockchain    ‚îÇ
‚îÇ                     ‚îÇ    ‚îÇ  - Create JSON      ‚îÇ    ‚îÇ                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ  - Upload IPFS      ‚îÇ    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                           ‚îÇ  - Update Contract  ‚îÇ           ‚îÇ
                           ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò           ‚îÇ
                                ‚îÇ           ‚îÇ                ‚îÇ
                                ‚îÇ           ‚ñº                ‚ñº
                                ‚îÇ     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                                ‚îÇ     ‚îÇ IPFS/Pinata  ‚îÇ  ‚îÇ   Smart      ‚îÇ
                                ‚îÇ     ‚îÇ  (Analysis)  ‚îÇ  ‚îÇ  Contract    ‚îÇ
                                ‚îÇ     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ (Scores +    ‚îÇ
                                ‚îÇ                       ‚îÇ  IPFS Hash)  ‚îÇ
                                ‚ñº                       ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                           ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                           ‚îÇ   Real-time     ‚îÇ
                           ‚îÇ   Monitoring    ‚îÇ
                           ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## üìã Project Structure

```
blackswan-oracle/
‚îú‚îÄ‚îÄ contracts/
‚îÇ   ‚îî‚îÄ‚îÄ BlackSwanOracle.sol    # UUPS upgradeable oracle contract
‚îú‚îÄ‚îÄ abi/
‚îÇ   ‚îî‚îÄ‚îÄ BlackSwanOracle.json   # Contract ABI for service interaction
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îî‚îÄ‚îÄ index.js               # Main oracle service implementation
‚îú‚îÄ‚îÄ package.json               # Dependencies and scripts
‚îú‚îÄ‚îÄ .gitignore                # Git ignore patterns
‚îî‚îÄ‚îÄ README.md                 # This documentation
```

## üöÄ Quick Start

### Prerequisites

- **Node.js** >= 18.0.0
- **Base RPC Access** (Alchemy, Infura, or public RPC)
- **Deployed Contract** on Base network
- **Dev Wallet** with Base ETH for transactions
- **Black Swan Platform API** access (simple API layer generated over the Market Peak and Blackswan Analysis outputs)

### Installation

1. **Clone and Install**

   ```bash
   git clone <repository-url>
   cd blackswan-oracle
   npm install
   ```

2. **Environment Configuration**

   Create a `.env` file based on `env.example` with the following configuration:

   ```env
   # Base Blockchain Configuration
   RPC_URL=https://base-mainnet.g.alchemy.com/v2/your-api-key
   DEV_WALLET_PRIVATE_KEY=your_64_character_private_key_without_0x_prefix

   # Smart Contract Configuration
   ORACLE_CONTRACT_ADDRESS=0x1234567890123456789012345678901234567890

   # API Configuration
   API_ENDPOINT=http://localhost:3001/api/oracle/stats
   API_ANALYSIS_ENDPOINT=http://localhost:3001/api/oracle/analysis

   # IPFS Configuration (Pinata)
   PINATA_API_KEY=your_pinata_api_key
   PINATA_SECRET_API_KEY=your_pinata_secret_api_key

   # Polling Configuration
   POLL_INTERVAL=60000          # 1 minute (minimum recommended)

   # HTTP Server Configuration
   PORT=8080               # Port for health check endpoints

   # Gas Configuration (Base Optimized)
   GAS_LIMIT=150000             # Higher for Base network
   MAX_FEE_PER_GAS_GWEI=2       # Base-appropriate gas fees
   MAX_PRIORITY_FEE_PER_GAS_GWEI=0.05

   # Alternative Base RPC URLs (for redundancy)
   # RPC_URL=https://base-mainnet.infura.io/v3/your-key
   # RPC_URL=https://mainnet.base.org
   # RPC_URL=https://base.llamarpc.com
   ```

3. **Start the Oracle Service**

   ```bash
   # Production mode
   npm start

   # Development mode (with auto-restart)
   npm run dev
   ```

## üîß Configuration

### Environment Variables

| Variable                        | Required | Default | Description                                                                    |
| ------------------------------- | -------- | ------- | ------------------------------------------------------------------------------ |
| `RPC_URL`                       | **Yes**  | -       | Base network RPC endpoint                                                      |
| `DEV_WALLET_PRIVATE_KEY`        | **Yes**  | -       | Private key (64 hex chars, no 0x prefix)                                       |
| `ORACLE_CONTRACT_ADDRESS`       | **Yes**  | -       | Deployed oracle contract address                                               |
| `API_ENDPOINT`                  | **Yes**  | -       | API endpoint generated over market peak and black swan analysis agent outcomes |
| `POLL_INTERVAL`                 | No       | 60000   | Polling interval in milliseconds                                               |
| `PORT`                          | No       | 8080    | Port for health check endpoints                                                |
| `GAS_LIMIT`                     | No       | 150000  | Gas limit for transactions                                                     |
| `MAX_FEE_PER_GAS_GWEI`          | No       | -       | Maximum fee per gas unit (Base: ~2 gwei)                                       |
| `MAX_PRIORITY_FEE_PER_GAS_GWEI` | No       | -       | Priority fee per gas unit (Base: ~0.05 gwei)                                   |
| `GAS_PRICE_GWEI`                | No       | -       | Legacy gas price (if EIP-1559 not available)                                   |

### Base Network Configuration

The service is optimized for Base (Chain ID: 8453). Key considerations:

- **Gas Fees**: Base has low fees (~0.001-0.01 ETH per transaction)
- **Block Time**: ~2 seconds for fast confirmations
- **RPC Endpoints**: Use Alchemy, Infura, or public Base RPC

### Smart Contract Features

The oracle uses a UUPS upgradeable contract with:

- **Owner Controls**: Contract upgrades, dev wallet management, pause/unpause
- **Dev Wallet Access**: Score updates, read operations
- **Pausable**: Emergency stop functionality
- **Events**: Comprehensive event logging for all operations

## üìä Score Update Logic

### Intelligent Update Strategy

The service implements smart update logic to minimize gas costs while ensuring all analysis changes are captured:

1. **Dual Score Monitoring**: Fetches both BlackSwan and Market Peak scores
2. **Deep Content Analysis**: Compares actual analysis content, not just scores
3. **Change Detection**: Triggers updates when:
   - **Score Changes**: When BlackSwan or Market Peak scores change
   - **Content Changes**: When analysis reasoning, indicators, or factors change (even if score stays the same)
   - **Timestamp Exclusion**: Ignores timestamp-only changes to avoid unnecessary updates
4. **Efficient Transactions**:
   - **Combined Update**: Uploads new IPFS JSONs and updates contract scores in one transaction
   - **No Update**: Only when both score AND content are identical to last update

### Update Flow

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Poll API          ‚îÇ
‚îÇ   Every Minute      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚îÇ
           ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Fetch Full        ‚îÇ
‚îÇ   Analysis Data     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚îÇ
           ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Deep Content Comparison           ‚îÇ
‚îÇ   - Compare scores                  ‚îÇ
‚îÇ   - Compare analysis text           ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ Cached Analysis
‚îÇ   - Compare reasoning               ‚îÇ
‚îÇ   - Compare indicators/factors      ‚îÇ
‚îÇ   - Exclude timestamps              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚îÇ
           ‚ñº
   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Real Changes? ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
   ‚îÇ                           ‚îÇ
   Yes (Score OR Content)      No (Identical)
   ‚îÇ                           ‚îÇ
   ‚ñº                           ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Create JSONs   ‚îÇ     ‚îÇ   Continue      ‚îÇ
‚îÇ  Upload IPFS    ‚îÇ     ‚îÇ   Monitoring    ‚îÇ
‚îÇ  Update Contract‚îÇ     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Key Features:**

- **Content-Aware**: Detects changes in analysis content even when score remains the same
- **Timestamp-Safe**: Ignores timestamp-only changes to prevent unnecessary updates
- **Cost-Optimized**: Only updates blockchain when real analysis changes occur
- **Comprehensive Logging**: Shows exactly which fields changed in each update

**Fields Compared for BlackSwan Analysis:**

- `score` - The BlackSwan risk score (0-100)
- `confidence` - Confidence level of the analysis
- `certainty` - Certainty percentage
- `analysis` - Detailed analysis text
- `reasoning` - Array of reasoning points
- `currentMarketIndicators` - Array of current market indicators
- `primaryRiskFactors` - Array of primary risk factors

**Fields Compared for Market Peak Analysis:**

- `score` - The Market Peak score (0-100)
- `summary` - Summary of the market peak analysis
- `keyFactors` - Array of key factors
- `reasoning` - Array of reasoning points

**Fields Explicitly Ignored (Not Compared):**

- `timestamp` - API generation timestamp
- `generatedAt` - JSON file creation timestamp
- `version` - Analysis version number
- `type` - Analysis type descriptor
- `dataSource` - Data source identifier

### Gas Optimization

- **Conditional Updates**: Only when data changes
- **Batch Operations**: Combined updates when possible
- **Base-Optimized**: Low gas settings for Base network
- **Smart Retry**: Automatic retry with adjusted gas on failure

## üîç API Integration

### Black Swan Platform API

The service connects to a API layer generated off the analysis outcomes of the Black Swan analysis agent and the Market Peak Analysis Agent

#### Endpoint 1: `/api/oracle/stats` (Legacy - Scores Only)

**Expected Response**:

```json
{
  "blackswanScore": 75,
  "marketPeakScore": 60,
  "timestamp": 1703123456789,
  "status": "ready"
}
```

#### Endpoint 2: `/api/oracle/analysis` (Full Analysis Data)

**Expected Response**:

```json
{
  "blackswan": {
    "score": 75,
    "confidence": "High",
    "certainty": 85,
    "timestamp": 1703123456789,
    "analysis": "Market shows concerning signs...",
    "reasoning": ["Indicator 1", "Indicator 2"],
    "currentMarketIndicators": ["BTC down 5%", "Volume spike"],
    "primaryRiskFactors": ["Regulatory uncertainty", "Market volatility"]
  },
  "marketPeak": {
    "score": 60,
    "timestamp": 1703123456789,
    "summary": "Market approaching local peak...",
    "keyFactors": ["Factor 1", "Factor 2"],
    "reasoning": ["Analysis point 1", "Analysis point 2"]
  },
  "status": "ready",
  "timestamp": 1703123456789
}
```

**Validation**:

- Both analysis objects must be present
- Scores must be numbers ‚â• 0
- Scores are converted to integers for blockchain storage
- API timeouts after 30 seconds
- Automatic retry on transient failures

### IPFS Data Structure

When analysis data is uploaded to IPFS, it follows this structure:

#### BlackSwan Analysis JSON

```json
{
  "type": "BlackSwan Analysis",
  "version": "1.0.0",
  "generatedAt": "2024-01-15T10:30:00.000Z",
  "score": 75,
  "confidence": "High",
  "certainty": 85,
  "analysis": "Comprehensive market analysis...",
  "reasoning": ["Point 1", "Point 2"],
  "currentMarketIndicators": ["Indicator 1", "Indicator 2"],
  "primaryRiskFactors": ["Risk 1", "Risk 2"],
  "timestamp": 1703123456789,
  "dataSource": "BlackSwan AI Analysis Engine"
}
```

#### Market Peak Analysis JSON

```json
{
  "type": "Market Peak Analysis",
  "version": "1.0.0",
  "generatedAt": "2024-01-15T10:30:00.000Z",
  "score": 60,
  "summary": "Market peak analysis summary...",
  "keyFactors": ["Factor 1", "Factor 2"],
  "reasoning": ["Analysis 1", "Analysis 2"],
  "timestamp": 1703123456789,
  "dataSource": "Market Peak AI Analysis Engine"
}
```

These JSON files are accessible via:

- `https://gateway.pinata.cloud/ipfs/{hash}`
- Any IPFS gateway: `https://{gateway}/ipfs/{hash}`

## üìà Monitoring & Logging

### Real-time Logs

The service provides comprehensive logging with emojis for easy monitoring:

```
2024-01-15 10:30:00 üìä [INFO] üîç Checking for analysis updates...
2024-01-15 10:30:01 üìä [INFO] üìä Fetched full analysis from API - BlackSwan: 75, MarketPeak: 60
2024-01-15 10:30:01 üìä [INFO] üîç Comparing analysis content for changes...
2024-01-15 10:30:01 üìä [INFO] üîç BlackSwan field 'reasoning' has changed
2024-01-15 10:30:01 üìä [INFO]    Old: ["Previous market volatility", "Low liquidity signals"]...
2024-01-15 10:30:01 üìä [INFO]    New: ["Increased market volatility", "Critical liquidity concerns"]...
2024-01-15 10:30:01 üìä [INFO] üìà Real changes detected:
2024-01-15 10:30:01 üìä [INFO]    - BlackSwan score: 70 ‚Üí 75
2024-01-15 10:30:01 üìä [INFO]    - BlackSwan analysis content changed (same score: 75)
2024-01-15 10:30:01 üìä [INFO] üìù Creating updated analysis JSON files...
2024-01-15 10:30:02 üìä [INFO] üì§ Uploading updated analysis to IPFS...
2024-01-15 10:30:03 üìä [INFO] üì§ Uploading blackswan-analysis-1703123456789.json to IPFS...
2024-01-15 10:30:04 üìä [INFO] ‚úÖ Successfully uploaded to IPFS: QmXx...abc
2024-01-15 10:30:04 üìä [INFO] üåê Access at: https://gateway.pinata.cloud/ipfs/QmXx...abc
2024-01-15 10:30:04 üìä [INFO] üìé IPFS URI: ipfs://QmXx...abc
2024-01-15 10:30:05 üìä [INFO] üì§ Uploading marketpeak-analysis-1703123456789.json to IPFS...
2024-01-15 10:30:06 üìä [INFO] ‚úÖ Successfully uploaded to IPFS: QmYy...def
2024-01-15 10:30:06 üìä [INFO] üåê Access at: https://gateway.pinata.cloud/ipfs/QmYy...def
2024-01-15 10:30:06 üìä [INFO] üìé IPFS URI: ipfs://QmYy...def
2024-01-15 10:30:07 üìä [INFO] üöÄ Updating oracle contract with scores and IPFS hashes
2024-01-15 10:30:07 üìä [INFO]    BlackSwan: 75 | IPFS: ipfs://QmXx...abc
2024-01-15 10:30:07 üìä [INFO]    MarketPeak: 60 | IPFS: ipfs://QmYy...def
2024-01-15 10:30:08 üìä [INFO] ‚è≥ Transaction sent: 0xabc123...
2024-01-15 10:30:10 üìä [INFO] ‚úÖ Scores and IPFS hashes updated successfully!
2024-01-15 10:30:10 üìä [INFO]    Block: 12345678, Gas used: 125000
2024-01-15 10:30:10 üìä [INFO]    üåê BlackSwan IPFS: https://gateway.pinata.cloud/ipfs/QmXx...abc
2024-01-15 10:30:10 üìä [INFO]    üåê MarketPeak IPFS: https://gateway.pinata.cloud/ipfs/QmYy...def
2024-01-15 10:30:10 üìä [INFO] üíæ All data updated successfully
```

**Example Log - No Changes (Score and Content Identical):**

```
2024-01-15 10:31:00 üìä [INFO] üîç Checking for analysis updates...
2024-01-15 10:31:01 üìä [INFO] üìä Fetched full analysis from API - BlackSwan: 75, MarketPeak: 60
2024-01-15 10:31:01 üìä [INFO] üîç Comparing analysis content for changes...
2024-01-15 10:31:01 üìä [INFO] üìä No real changes detected - BlackSwan: 75, MarketPeak: 60
2024-01-15 10:31:01 üìä [INFO]    (Score and content are identical to last update)
```

**Example Log - Content Changed, Same Score:**

```
2024-01-15 10:32:00 üìä [INFO] üîç Checking for analysis updates...
2024-01-15 10:32:01 üìä [INFO] üìä Fetched full analysis from API - BlackSwan: 75, MarketPeak: 60
2024-01-15 10:32:01 üìä [INFO] üîç Comparing analysis content for changes...
2024-01-15 10:32:01 üìä [INFO] üîç BlackSwan field 'currentMarketIndicators' has changed
2024-01-15 10:32:01 üìä [INFO]    Old: ["BTC down 5%", "Volume spike"]...
2024-01-15 10:32:01 üìä [INFO]    New: ["BTC down 8%", "Record volume spike", "New regulatory concerns"]...
2024-01-15 10:32:01 üìä [INFO] üìà Real changes detected:
2024-01-15 10:32:01 üìä [INFO]    - BlackSwan analysis content changed (same score: 75)
2024-01-15 10:32:02 üìä [INFO] üìù Creating updated analysis JSON files...
[...continues with IPFS upload and contract update...]
```

### Log Categories

| Emoji | Level | Category              | Description                    |
| ----- | ----- | --------------------- | ------------------------------ |
| üìä    | INFO  | General Operations    | Normal service operations      |
| üîç    | INFO  | Data Fetching         | API polling and data retrieval |
| üìà    | INFO  | Score Changes         | Score updates and comparisons  |
| üìù    | INFO  | JSON Creation         | Creating analysis JSON files   |
| üì§    | INFO  | IPFS Operations       | Uploading to IPFS/Pinata       |
| üåê    | INFO  | IPFS Access           | IPFS gateway URLs              |
| üìé    | INFO  | IPFS URI              | IPFS URIs (ipfs://)            |
| üöÄ    | INFO  | Blockchain Operations | Contract interactions          |
| ‚è≥    | INFO  | Transaction Progress  | Transaction submission         |
| ‚úÖ    | INFO  | Success Operations    | Successful completions         |
| üíæ    | INFO  | Cache Operations      | Data caching and storage       |
| üìå    | INFO  | Pinata Auth           | Pinata authentication          |
| ‚ö†Ô∏è    | WARN  | Warnings              | Non-critical issues            |
| ‚ùå    | ERROR | Errors                | Critical failures              |

### Health Monitoring

Monitor these key indicators:

- **API Response Time**: Should be < 5 seconds
- **IPFS Upload Time**: Should be < 10 seconds per file
- **Transaction Success Rate**: Should be > 95%
- **Gas Usage**: Monitor for unusual spikes (expect ~200k for IPFS updates)
- **Score Update Frequency**: Track how often scores change
- **Wallet Balance**: Alert when ETH balance is low
- **Pinata Storage**: Monitor total pinned data size
- **IPFS Gateway Availability**: Verify uploaded files are accessible

## üõ†Ô∏è Development

### Local Development

```bash
# Install dependencies
npm install

# Run with auto-restart
npm run dev

# Check code style
npm run lint

# Format code
npm run format
```

### Testing

```bash
# Test API connectivity
curl http://localhost:3001/api/oracle/stats

# Check contract interaction (requires deployed contract)
npm start

# Monitor logs
tail -f logs/oracle.log
```

### Smart Contract Development

The oracle contract supports:

```solidity
// Score updates
updateBlackSwanScore(uint256 newScore)
updateMarketPeakScore(uint256 newScore)
updateBothScores(uint256 newBlackSwanScore, uint256 newMarketPeakScore)

// IPFS hash updates
updateBlackSwanAnalysisIPFS(string memory ipfsHash)
updateMarketPeakAnalysisIPFS(string memory ipfsHash)
updateBothAnalysisIPFS(string memory blackSwanIPFS, string memory marketPeakIPFS)

// Combined update (most efficient - used by oracle service)
updateScoresAndAnalysis(
    uint256 newBlackSwanScore,
    uint256 newMarketPeakScore,
    string memory blackSwanIPFS,
    string memory marketPeakIPFS
)

// Read operations - Scores
getBothScores() returns (uint256 blackSwan, uint256 marketPeak)
blackSwanScore() returns (uint256)
marketPeakScore() returns (uint256)

// Read operations - IPFS
getBothAnalysisIPFS() returns (string memory blackSwanIPFS, string memory marketPeakIPFS)
blackSwanAnalysisIPFS() returns (string memory)
marketPeakAnalysisIPFS() returns (string memory)

// Read operations - All data
getAllData() returns (
    uint256 blackSwan,
    uint256 marketPeak,
    string memory blackSwanIPFS,
    string memory marketPeakIPFS
)
```

**Key Contract Features:**

- **UUPS Upgradeable**: Can be upgraded without changing the contract address
- **Access Control**: Owner and dev wallets can update data
- **Pausable**: Can be paused in emergency situations
- **Event Emission**: All updates emit events for tracking
- **Gas Optimized**: Combined updates save gas over individual calls

## üöÄ Deployment

### Production Deployment

1. **Server Setup**

   ```bash
   # Clone to production server
   git clone <repository-url>
   cd blackswan-oracle
   npm ci --production
   ```

2. **Environment Configuration**

   ```env
   # Production environment
   NODE_ENV=production
   RPC_URL=https://base-mainnet.g.alchemy.com/v2/production-key
   API_ENDPOINT=http://localhost:3001/api/oracle/stats
   POLL_INTERVAL=60000
   ```

3. **Process Management**

   ```bash
   # Using PM2
   npm install -g pm2
   pm2 start src/index.js --name "blackswan-oracle"
   pm2 startup
   pm2 save

   # Using systemd
   sudo systemctl enable blackswan-oracle
   sudo systemctl start blackswan-oracle
   ```

### Docker Deployment

```dockerfile
FROM node:18-alpine

WORKDIR /app
COPY package*.json ./
RUN npm ci --production

COPY . .

USER node
CMD ["npm", "start"]
```

```bash
# Build and run
docker build -t blackswan-oracle .
docker run -d --env-file .env --name oracle blackswan-oracle
```

### Base Network Deployment

For Base mainnet deployment:

1. **Get Base ETH**: Bridge from Ethereum mainnet
2. **Deploy Contract**: Use Remix, Hardhat, or Foundry
3. **Add Dev Wallet**: Call `addDevWallet()` with service wallet
4. **Configure Service**: Update `.env` with contract address

### Monitoring Setup

```bash
# Health check endpoint (add to your monitoring)
curl http://localhost:8080/health

# Log monitoring
tail -f /var/log/blackswan-oracle/app.log

# Performance monitoring
htop | grep "node.*oracle"
```

## üîí Security

### Best Practices

1. **Private Key Security**

   - Use environment variables only
   - Never commit private keys to version control
   - Consider using hardware wallets or key management services
   - Rotate keys regularly

2. **Access Control**

   - Deploy contract with secure initial owner
   - Use multi-signature wallets for production
   - Limit dev wallet permissions to necessary functions
   - Regular access audits

3. **Network Security**

   - Use HTTPS for all API endpoints
   - Implement API rate limiting
   - Monitor for unusual transaction patterns
   - Set up alerts for failed transactions

4. **Smart Contract Security**
   - Contract is pausable for emergencies
   - Upgradeable pattern allows security fixes
   - Events provide transaction transparency
   - Access controls prevent unauthorized updates

### Security Checklist

- [ ] Private keys stored securely (not in code)
- [ ] Environment variables properly configured
- [ ] Contract deployed with correct owner
- [ ] Dev wallet added to contract allowlist
- [ ] API endpoints use HTTPS
- [ ] Monitoring and alerting configured
- [ ] Backup RPC endpoints configured
- [ ] Regular security updates scheduled

## üêõ Troubleshooting

### Common Issues

#### 1. "Missing required environment variable"

```bash
# Check your .env file
cat .env

# Verify all required variables are set
grep -E "(RPC_URL|DEV_WALLET_PRIVATE_KEY|ORACLE_CONTRACT_ADDRESS|API_ENDPOINT)" .env
```

#### 2. "Invalid contract address format"

```bash
# Ensure address is 42 characters with 0x prefix
echo $ORACLE_CONTRACT_ADDRESS | wc -c  # Should be 43 (including newline)
```

#### 3. "Connected to Chain ID X, but Base mainnet is 8453"

```bash
# Verify RPC URL points to Base mainnet
curl -X POST -H "Content-Type: application/json" \
  --data '{"jsonrpc":"2.0","method":"eth_chainId","params":[],"id":1}' \
  $RPC_URL
```

#### 4. "Insufficient funds in dev wallet"

```bash
# Check wallet balance on Base
# Use Base explorer: https://basescan.org/address/YOUR_WALLET_ADDRESS
```

#### 5. "API request timed out"

```bash
# Test API endpoint manually
curl -v http://localhost:3001/api/oracle/stats
```

#### 6. "Contract error: caller is not owner or dev wallet"

```bash
# Verify wallet is added as dev wallet in contract
# Check contract on BaseScan for dev wallet list
```

### Debug Mode

Enable detailed logging:

```env
LOG_LEVEL=debug
```

Check specific components:

```bash
# Test API connectivity
curl -v $API_ENDPOINT

# Test blockchain connection
node -e "
const { ethers } = require('ethers');
const provider = new ethers.JsonRpcProvider(process.env.RPC_URL);
provider.getNetwork().then(console.log);
"

# Verify contract ABI
node -e "
const abi = require('./abi/BlackSwanOracle.json');
console.log('Contract ABI loaded:', abi.length, 'functions');
"
```

### Performance Monitoring

Track key metrics:

```bash
# Service uptime
ps aux | grep "node.*index.js"

# Memory usage
top -p $(pgrep -f "node.*index.js")

# Blockchain connectivity
curl -X POST -H "Content-Type: application/json" \
  --data '{"jsonrpc":"2.0","method":"eth_blockNumber","params":[],"id":1}' \
  $RPC_URL
```

## üìö API Reference

### Service Methods

#### `fetchScoresFromAPI()`

Fetches both BlackSwan and Market Peak scores from the Black Swan Platform API layer.

**Returns**: `Promise<{blackswanScore: number, marketPeakScore: number}>`

#### `updateOracleScores(blackswanScore, marketPeakScore, updateType)`

Updates the oracle contract with new scores.

**Parameters**:

- `blackswanScore`: New BlackSwan score (integer)
- `marketPeakScore`: New Market Peak score (integer)
- `updateType`: "both" | "blackswan" | "marketpeak"

**Returns**: `Promise<boolean>` - Success status

#### `checkAndUpdateScores()`

Main monitoring loop that checks for changes and updates accordingly.

### Smart Contract Interface

```solidity
interface IBlackSwanOracle {
    function updateBlackSwanScore(uint256 newScore) external;
    function updateMarketPeakScore(uint256 newScore) external;
    function updateBothScores(uint256 newBlackSwanScore, uint256 newMarketPeakScore) external;
    function getBothScores() external view returns (uint256, uint256);
    function blackSwanScore() external view returns (uint256);
    function marketPeakScore() external view returns (uint256);
}
```

## ü§ù Contributing

### Development Workflow

1. Fork the repository
2. Create a feature branch
3. Make your changes
4. Add tests if applicable
5. Update documentation
6. Submit a pull request

### Code Standards

- **ESLint**: Follow project linting rules
- **Comments**: Add JSDoc for new functions
- **Error Handling**: Always handle errors gracefully
- **Logging**: Use appropriate log levels with emojis
- **Security**: Never expose private keys or sensitive data

### Testing Guidelines

```bash
# Unit tests
npm test

# Integration tests
npm run test:integration

# Linting
npm run lint

# Security audit
npm audit
```

## üìÑ License

This project is licensed under the MIT License - see the [LICENSE](LICENSE) file for details.

## üë®‚Äçüíª Author

**Muhammad Bilal Motiwala**

- GitHub: [@bilalmotiwala](https://github.com/bilalmotiwala)
- Email: [bilal@oaiaolabs.com](mailto:bilal@oaiaolabs.com)

## üÜò Support

### Getting Help

1. **Documentation**: Review this README and code comments
2. **Logs**: Check service logs for detailed error information
3. **API Testing**: Test components individually using provided commands
4. **GitHub Issues**: Create an issue for bugs or feature requests

### Community Resources

- **Base Documentation**: [docs.base.org](https://docs.base.org)
- **Ethers.js Docs**: [docs.ethers.org](https://docs.ethers.org)
- **Black Swan**: [blackswan.wtf](https://blackswan.wtf)

---

**‚ö†Ô∏è Important Notes:**

- **Security**: Keep private keys secure and never commit them to version control
- **Gas Fees**: Monitor Base network gas prices and adjust accordingly
- **Monitoring**: Set up proper monitoring and alerting for production use
- **Updates**: Keep dependencies updated for security patches
- **Testing**: Always test on testnet before mainnet deployment

**üöÄ Ready to deploy your oracle!**
